"use strict";var _createClass=function(){function i(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),e}}(),_get=function e(t,r,i){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,r);if(void 0===n){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,i)}if("value"in n)return n.value;var o=n.get;return void 0!==o?o.call(i):void 0};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}!function(s,l){var t=function(e){function i(e,t){_classCallCheck(this,i);var r=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,t));return r.question=Object.values(t.questions)[0],r.canvas=document.createElement("canvas"),r.useFriendProfile="friend"===r.question.profile,r}return _inherits(i,s.Quiz),_createClass(i,[{key:"loadEvents",value:function(){var t=this;_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"loadEvents",this).call(this),this.$wrapper.on("click",".wq_loginFB",function(e){return t.handleClickLoginButton(e)});var r=this.$wrapper.find(".wq-continue-as-btn");r.length&&void 0!==window.fbLoaded&&window.fbLoaded.promise.then(function(){FB.getLoginStatus(function(e){"connected"===e.status&&FB.api("/me","get",{fields:"first_name"},function(e){if(e.first_name){var t=e.first_name;FB.api("/me/picture","get",{redirect:!1},function(e){e.data.url?(r.children("span").text(s.i18n.continueAs.replace("%s",t)),r.append('<img src="'+e.data.url+'">')):console.log(e)})}})})})}},{key:"showLoader",value:function(){this.$wrapper.find(".wq_loader-container").show()}},{key:"hideLoader",value:function(){this.$wrapper.find(".wq_loader-container").hide()}},{key:"handleClickLoginButton",value:function(e){var t=this;if(e.preventDefault(),"undefined"!=typeof FB){this.showLoader();var r="email";this.useFriendProfile&&(r+=",user_friends"),FB.getLoginStatus(function(e){"connected"!==e.status?FB.login(function(e){"connected"!==e.status?(console.log("login failed",e),t.hideLoader()):t.processQuiz(e)},{scope:r}):t.processQuiz(e)})}}},{key:"getRandomResult",value:function(){var e=Object.keys(this.results);return this.results[e[Math.floor(Math.random()*e.length)]]}},{key:"processQuiz",value:function(e){var r=this,i={profile:{id:e.authResponse.userID},result:this.getRandomResult()};FB.api("/me","get",{fields:"first_name,last_name,email"},function(e){if(!e.first_name)return console.log(e),alert(s.i18n.errorLoadProfile),void r.hideLoader();i.profile.first_name=e.first_name,i.profile.last_name=e.last_name,i.profile.email=e.email,i.profile.gender=e.gender;var t={redirect:!1};parseFloat(i.result.proImageHeight)&&(t.height=parseInt(i.result.proImageHeight)),parseFloat(i.result.proImageWidth)&&(t.width=parseInt(i.result.proImageWidth)),FB.api("/me/picture","get",t,function(e){if(!e.data.url)return console.log(e),alert(s.i18n.errorLoadAvatar),void r.hideLoader();i.profile.picture=e.data.url,FB.api("/me/friends","get",{},function(e){void 0!==e.data&&(i.profile.friends=e.data,r.generateImage(i))})})})}},{key:"generateImage",value:function(u){var f=this,e=this.getImage(u.result.image),i=document.createElement("canvas"),d=i.getContext("2d"),o=function(){var t=i.toDataURL("image/jpeg",.9),e=s.restUrl+"wp-quiz/v2/play_data",r=s.helpers.getRequest({url:e,method:"POST",data:{quiz_id:f.quizId,quiz_data:JSON.stringify(f.quizData),result_id:u.result.id,profile:u.profile,answered:t,current_url:window.location.href}});r.done(function(e){f.$wrapper.find(".wq-result").attr("data-id",u.result.id),f.$wrapper.find(".wq-result-img").attr("src",t),f.$wrapper.find(".wq-result-desc").html(u.result.desc.replace(new RegExp(Object.keys(u.replaces).join("|"),"gi"),function(e){return u.replaces[e]})),f.$wrapper.find(".wq-results, .wq-result").show(),f.$wrapper.find(".wq-questions, .wq_loader-container").hide(),"number"==typeof e&&(f.$wrapper.find(".wq-share button").attr("data-tracking-id",e),f.$wrapper.find(".wq_forceShareFB").attr("data-tracking-id",e))}),r.fail(function(e){console.error(e)})},t=function(){if(!u.profile.friends.length)return alert(s.i18n.errorNoFriends),f.hideLoader(),void console.log("no friends");var i=JSON.parse(JSON.stringify(u.profile.friends)),e=Object.keys(i),t=e[Math.floor(Math.random()*e.length)],n=i[t];delete i[t],u.friend=n;var a={fontSize:f.settings.title_size,fontWeight:f.settings.title_weight,fontStyle:f.settings.title_style,color:f.settings.title_color,x:u.result.pos_title_x,y:u.result.pos_title_y,width:u.result.titleImageWidth,replaces:{"%%userfirstname%%":u.profile.first_name,"%%userlastname%%":u.profile.last_name,"%%friendfirstname%%":"","%%friendlastname%%":""}};FB.api(n.id,"get",{fields:"first_name,last_name"},function(e){if(e.first_name){a.replaces["%%friendfirstname%%"]=e.first_name,a.replaces["%%friendlastname%%"]=e.last_name,f.drawText(d,u.result.title,a),u.replaces=l.extend({},a.replaces);var r={x:u.result.pos_x,y:u.result.pos_y,radius:u.result.imageRadius},t={redirect:!1};parseFloat(u.result.proImageHeight)&&(t.height=parseInt(u.result.proImageHeight)),parseFloat(u.result.proImageWidth)&&(t.width=parseInt(u.result.proImageWidth)),FB.api(n.id+"/picture","get",t,function(e){if(e.data.url){var t=f.getImage(e.data.url);t.onload=function(){if(r.width=u.result.proImageWidth||t.width,r.height=u.result.proImageHeight||t.height,f.drawImage(d,t,r),u.result.extra_profiles&&1<u.profile.friends.length){var e=u.result.extra_profiles;return s=i,l=[],e.forEach(function(e){var t=e.split(","),r=Object.keys(s);if(r.length){var i=r[Math.floor(Math.random()*r.length)],n=s[i];delete s[i];var a={fontSize:f.settings.title_size,fontWeight:f.settings.title_weight,fontStyle:f.settings.title_style,color:f.settings.title_color,x:t[6],y:t[7],width:t[5],replaces:{"%%friendfirstname%%":"","%%friendlastname%%":""}},o={x:t[3],y:t[4],width:t[0],height:t[1],radius:t[2]};l.push(new Promise(function(t,r){FB.api(n.id,"get",{fields:"first_name,last_name"},function(e){e.first_name?(a.replaces["%%friendfirstname%%"]=e.first_name,a.replaces["%%friendlastname%%"]=e.last_name,f.drawText(d,u.result.title,a),t(e)):r(e)})})),l.push(new Promise(function(r,i){var e={redirect:!1};parseFloat(t[0])&&(e.height=parseInt(t[0])),parseFloat(t[1])&&(e.width=parseInt(t[1])),FB.api(n.id+"/picture","get",e,function(e){if(e.data.url){var t=f.getImage(e.data.url);t.onload=function(){o.width=t.width,o.height=t.height,f.drawImage(d,t,o),r(e)}}else i(e)})}))}}),void Promise.all(l).then(function(e){o()})}var s,l;o()}}})}})},r=function(){1200<e.width&&(e.height=1200*e.height/e.width,e.width=1200),i.width=e.width,i.height=e.height,f.drawImage(d,e,{width:i.width,height:i.height}),f.useFriendProfile?t():function(){var e={fontSize:f.settings.title_size,fontWeight:f.settings.title_weight,fontStyle:f.settings.title_style,color:f.settings.title_color,x:u.result.pos_title_x,y:u.result.pos_title_y,width:u.result.titleImageWidth,replaces:{"%%userfirstname%%":u.profile.first_name,"%%userlastname%%":u.profile.last_name}};f.drawText(d,u.result.title,e),u.replaces=l.extend({},e.replaces);var t=f.getImage(u.profile.picture),r={x:u.result.pos_x,y:u.result.pos_y,width:u.result.proImageWidth||t.width,height:u.result.proImageHeight||t.height,radius:u.result.imageRadius};t.onload=function(){f.drawImage(d,t,r),o()}}()};e.onload=function(){return r()}}},{key:"getImage",value:function(e){var t=new Image;return t.crossOrigin="anonymous",t.src=e,t}},{key:"drawImage",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=parseInt(r.x)||0,n=parseInt(r.y)||0,a=parseInt(r.width)||0,o=parseInt(r.height)||0,s=parseInt(r.radius)||0;e.save(),0<s&&(a/2<=s?(s=a/2,e.beginPath(),e.arc(i+s,n+s,s,0,2*Math.PI)):(e.beginPath(),e.moveTo(i+s,n),e.lineTo(i+a-s,n),e.quadraticCurveTo(i+a,n,i+a,n+s),e.lineTo(i+a,n+o-s),e.quadraticCurveTo(i+a,n+o,i+a-s,n+o),e.lineTo(i+s,n+o),e.quadraticCurveTo(i,n+o,i,n+o-s),e.lineTo(i,n+s),e.quadraticCurveTo(i,n,i+s,n)),e.closePath(),e.clip()),e.drawImage(t,i,n,a,o),e.restore()}},{key:"drawText",value:function(r,e){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=parseInt(t.fontSize)||16,n=t.fontWeight||700,a=t.fontStyle||"normal",o=t.fontFamily||"Arial",s=t.color||"#333",l=parseInt(t.x||0),u=parseInt(t.y||0)+i,f=parseInt(t.width||0),d=t.lineHeight||1.4*i,c=t.replaces||{};for(var p in c)e=e.replace(p,c[p]);if(r.font=a+" normal "+n+" "+i+"px "+o,r.fillStyle=s,f){var h="",g=u;e.split(" ").forEach(function(e){if(e)if(h){var t=r.measureText(h+" "+e);h=t.width<=f?h+" "+e:(r.fillText(h,l,g),g+=d,e)}else h+=e}),r.fillText(h,l,g)}else r.fillText(e,l,u)}}]),i}();l(document).ready(function(){l(".wq-quiz-fb_quiz").each(function(){var e=l(this).attr("data-quiz-id");void 0!==window["fb_quizQuiz"+e]&&new t(l(this),window["fb_quizQuiz"+e])})})}(wpQuiz,jQuery);